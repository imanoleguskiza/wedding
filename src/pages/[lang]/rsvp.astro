---
import Base from '../../layouts/Base.astro';
import { languages, translations, type Lang, type Translation } from '../../lib/i18n';

export function getStaticPaths() {
  return languages.map((lang) => ({
    params: { lang },
    props: { lang, t: translations[lang] }
  }));
}

const langParam = (Astro.params.lang as Lang) ?? (Astro.props as any)?.lang ?? 'en';
const lang: Lang = languages.includes(langParam) ? langParam : 'en';
const t: Translation = (Astro.props as any)?.t ?? translations[lang];
---
<Base lang={lang} page="rsvp" t={t}>
  <section>
    <div class="section-title">{t.rsvp.title}</div>
    <div class="form-card">
      <p style="text-align:center; margin-top:0;">{t.rsvp.intro}</p>
      <form id="rsvp-form">
        <div>
          <label for="names">{t.rsvp.fields.names}</label>
          <input id="names" name="names" required placeholder={t.rsvp.placeholders.names} />
        </div>
        <div>
          <label for="email">{t.rsvp.fields.email}</label>
          <input id="email" name="email" type="email" required placeholder={t.rsvp.placeholders.email} />
        </div>
        <div>
          <label for="attendance">{t.rsvp.fields.attendance}</label>
          <select id="attendance" name="attendance" required>
            <option value="">—</option>
            <option value="yes">{t.rsvp.attendanceOptions.yes}</option>
            <option value="no">{t.rsvp.attendanceOptions.no}</option>
          </select>
        </div>
        <div>
          <label for="guests">{t.rsvp.fields.guests}</label>
          <input id="guests" name="guests" type="number" min="0" max="10" value="1" />
        </div>
        <div>
          <label for="diet">{t.rsvp.fields.diet}</label>
          <textarea id="diet" name="diet" placeholder={t.rsvp.placeholders.diet}></textarea>
        </div>
        <div>
          <label for="song">{t.rsvp.fields.song}</label>
          <input id="song" name="song" placeholder={t.rsvp.placeholders.song} />
        </div>
        <div>
          <label for="message">{t.rsvp.fields.message}</label>
          <textarea id="message" name="message" placeholder={t.rsvp.placeholders.message}></textarea>
        </div>
        <button type="submit">{t.rsvp.submit}</button>
        <p class="status" id="rsvp-status"></p>
      </form>
    </div>
  </section>
</Base>

<script type="module" data-status={JSON.stringify(t.rsvp.status)}>
  const form = document.querySelector('#rsvp-form');
  const statusEl = document.querySelector('#rsvp-status');
  const statusMessages = JSON.parse(document.currentScript?.dataset?.status ?? '{}');

  const setStatus = (text, color = 'var(--muted)') => {
    if (!statusEl) return;
    statusEl.textContent = text;
    statusEl.style.color = color;
  };

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    setStatus(statusMessages.sending || 'Sending…');

    const data = Object.fromEntries(new FormData(form).entries());
    try {
      const res = await fetch('/api/rsvp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const message = await res.text();
        throw new Error(message || 'Unable to send RSVP');
      }

      setStatus(statusMessages.success || 'Thank you!', 'var(--sage-dark)');
      form.reset();
    } catch (err) {
      console.error(err);
      setStatus(statusMessages.error || 'Something went wrong.', '#b45309');
    }
  });
</script>
